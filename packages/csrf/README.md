---
name: CSRF
dependencies: session
---

Cross-site request forgery 跨站请求伪造

## 原理 & 场景

客户端和服务器通信，如果服务器需要确定客户端的身份，为了避免每次通信进行一次身份验证，一般需要一种会话机制 #session# 控制。

而这个 session 机制在浏览器里使用一个 cookie 来保存会话的 token。

cookie 又是和域名绑定，所以只要发起请求，无论来源哪里，服务器都可以拿到这个 token，也就认为客户端值得信任。

于是利用这个原理，攻击者就可以代替用户的发布请求，从而以用户的身份篡改 URL 参数做一些事情，通过：

- 做了一个钓鱼网站，里面有一段脚本或者图片直接请求目标地址，用户经不住诱惑访问了这个网站
- 给用户直接发目标地址的 URL，用户一看 URL 地址是没问题的，无意点开

## 预防

服务器需要校验请求来源：

1. referrer 校验，这个方法有几个问题：
  - 浏览器并不一定是安全的，可能也受到攻击或者本身漏洞导致 referrer 被篡改
  - 隐私和用户设置问题导致 referrer 丢失问题，导致正常的请求也无法通过了
1. 非 cookie 信息同时又无法伪造的信息，为用户生成一个 token，存储在服务器中，同时输出到用户页面中，保证别人跨域无法拿到，请求每次再带上这个 token 和服务器存的 token 做对比，token 加载请求参数还是 header 里都可以，根据业务场景决定。但是需要手动为请求添加 token，能不能自动加呢，这个涉及到业务架构的设计了，不好统一添加。
